<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>TON Кошелёк Генератор и Проверка баланса</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px;
    }
    h1 { color: #2c3e50; }
    .container {
      width: 100%;
      max-width: 600px;
      margin-bottom: 20px;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    textarea {
      width: 100%;
      height: 80px;
      font-size: 16px;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #2980b9; }
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      width: 100%;
    }
    .address { font-weight: bold; color: #16a085; }
    .balance { font-weight: bold; color: #8e44ad; }
    .mnemonic { 
      font-weight: bold; 
      color: #e74c3c; 
      word-break: break-all;
      margin: 10px 0;
    }
    .auto-mode {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 600px;
      margin-bottom: 20px;
    }
    .stats {
      margin-top: 10px;
      font-size: 14px;
      color: #7f8c8d;
    }
    .found-wallets {
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 5px;
    }
    .wallet-item {
      margin-bottom: 10px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 5px;
      border-left: 4px solid #2ecc71;
    }
    .current-phrase {
      margin: 15px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px dashed #ccc;
    }
    .current-phrase-text {
      font-family: monospace;
      word-break: break-all;
      color: #e74c3c;
    }
  </style>
</head>
<body>
  <h1>TON Кошелёк Генератор и Проверка баланса</h1>
  
  <div class="auto-mode">
    <h2>Автоматический режим</h2>
    <button id="startAutoBtn">Запустить автоматическую генерацию</button>
    <button id="stopAutoBtn" disabled>Остановить</button>
    
    <div class="current-phrase">
      <p><strong>Текущая проверяемая фраза:</strong></p>
      <div id="currentPhrase" class="current-phrase-text">Не активен</div>
    </div>
    
    <div class="stats">
      <p>Сгенерировано кошельков: <span id="generatedCount">0</span></p>
      <p>Найдено с балансом: <span id="foundCount">0</span></p>
      <p>Статус: <span id="status">Остановлено</span></p>
    </div>
    
    <div id="foundWallets" class="found-wallets" style="display: none;">
      <h3>Найденные кошельки с балансом:</h3>
    </div>
  </div>
  
  <div class="container">
    <h2>Генерация кошелька</h2>
    <button id="generateBtn">Сгенерировать новый кошелёк</button>
    <div id="walletResult" class="result" style="display:none;"></div>
  </div>

  <div class="container">
    <h2>Проверка баланса</h2>
    <p>Вставь свою мнемоническую фразу (12–24 слова):</p>
    <textarea id="mnemonic"></textarea><br>
    <button id="checkBtn">Проверить баланс</button>

    <div id="balanceResult" class="result" style="display:none;"></div>
  </div>

  <script type="module">
    import { mnemonicToWalletKey, mnemonicNew } from "https://esm.sh/@ton/crypto";
    import { WalletContractV4 } from "https://esm.sh/@ton/ton";

    const generateBtn = document.getElementById("generateBtn");
    const walletResult = document.getElementById("walletResult");
    const checkBtn = document.getElementById("checkBtn");
    const balanceResult = document.getElementById("balanceResult");
    const mnemonicInput = document.getElementById("mnemonic");
    const startAutoBtn = document.getElementById("startAutoBtn");
    const stopAutoBtn = document.getElementById("stopAutoBtn");
    const generatedCountEl = document.getElementById("generatedCount");
    const foundCountEl = document.getElementById("foundCount");
    const statusEl = document.getElementById("status");
    const foundWalletsEl = document.getElementById("foundWallets");
    const currentPhraseEl = document.getElementById("currentPhrase");

    let isAutoModeRunning = false;
    let generatedCount = 0;
    let foundCount = 0;
    let foundWallets = [];

    // Генерация нового кошелька
    generateBtn.addEventListener("click", async () => {
      try {
        await generateWallet();
      } catch (e) {
        console.error(e);
        alert("Ошибка при генерации кошелька: " + e.message);
      }
    });

    // Проверка баланса
    checkBtn.addEventListener("click", async () => {
      const phrase = mnemonicInput.value.trim();
      if (!phrase) {
        alert("Введите мнемоническую фразу!");
        return;
      }
      checkBalance(phrase);
    });

    // Запуск автоматического режима
    startAutoBtn.addEventListener("click", () => {
      isAutoModeRunning = true;
      startAutoBtn.disabled = true;
      stopAutoBtn.disabled = false;
      statusEl.textContent = "Выполняется...";
      runAutoMode();
    });

    // Остановка автоматического режима
    stopAutoBtn.addEventListener("click", () => {
      isAutoModeRunning = false;
      startAutoBtn.disabled = false;
      stopAutoBtn.disabled = true;
      statusEl.textContent = "Остановлено";
      currentPhraseEl.textContent = "Не активен";
    });

    // Функция автоматической генерации и проверки
    async function runAutoMode() {
      while (isAutoModeRunning) {
        try {
          await generateAndCheck();
          // Небольшая задержка между запросами чтобы не перегружать API
          await new Promise(resolve => setTimeout(resolve, 1000));
        } catch (e) {
          console.error("Ошибка в автоматическом режиме:", e);
          // Продолжаем работу даже при ошибках
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
      }
    }

    // Генерация и проверка кошелька
    async function generateAndCheck() {
      const phrase = await generateWallet(true);
      if (phrase) {
        await checkBalance(phrase, true);
      }
    }

    // Функция генерации кошелька
    async function generateWallet(silent = false) {
      // Генерируем новую мнемоническую фразу (24 слова)
      const mnemonic = await mnemonicNew(24);
      const mnemonicPhrase = mnemonic.join(" ");
      
      // Вставляем фразу в поле ввода
      if (!silent) {
        mnemonicInput.value = mnemonicPhrase;
      }
      
      // Отображаем текущую фразу в автоматическом режиме
      if (isAutoModeRunning) {
        currentPhraseEl.textContent = mnemonicPhrase;
      }
      
      // Получаем ключи из мнемоники
      const keyPair = await mnemonicToWalletKey(mnemonic);

      // Создаём кошелёк версии 4
      const wallet = WalletContractV4.create({
        workchain: 0,
        publicKey: keyPair.publicKey,
      });
      
      const address = wallet.address.toString();
      
      // Обновляем счетчик
      generatedCount++;
      generatedCountEl.textContent = generatedCount;
      
      // Формируем сообщение с результатом
      if (!silent) {
        walletResult.innerHTML = `
          <p>Мнемоническая фраза:</p>
          <p class="mnemonic">${mnemonicPhrase}</p>
          <p>Адрес: <span class="address">${address}</span></p>
          <p><strong>Сохраните мнемоническую фразу в безопасном месте!</strong></p>
        `;
        walletResult.style.display = "block";
      }
      
      return mnemonicPhrase;
    }

    // Функция проверки баланса
    async function checkBalance(phrase, silent = false) {
      try {
        const mnemonic = phrase.split(/\s+/);
        const keyPair = await mnemonicToWalletKey(mnemonic);

        // Создаём кошелёк
        const wallet = WalletContractV4.create({
          workchain: 0,
          publicKey: keyPair.publicKey,
        });
        const address = wallet.address.toString();

        // Получаем баланс через toncenter API
        const url = `https://toncenter.com/api/v2/getAddressInformation?address=${address}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.ok) {
          const balance = parseInt(data.result.balance, 10) / 1e9;
          
          if (!silent) {
            balanceResult.innerHTML = `
              <p>Адрес: <span class="address">${address}</span></p>
              <p>Баланс: <span class="balance">${balance} TON</span></p>
            `;
            balanceResult.style.display = "block";
          }
          
          // Если баланс больше 0, сохраняем информацию
          if (balance > 0) {
            foundCount++;
            foundCountEl.textContent = foundCount;
            
            const walletInfo = {
              mnemonic: phrase,
              address: address,
              balance: balance
            };
            
            foundWallets.push(walletInfo);
            saveFoundWallet(walletInfo);
            
            // Показываем уведомление
            if (!silent) {
              alert(`Найден кошелёк с балансом! ${balance} TON`);
            }
          }
          
          return balance;
        } else {
          if (!silent) {
            balanceResult.innerHTML = `<p style="color:red;">Ошибка API: ${JSON.stringify(data)}</p>`;
            balanceResult.style.display = "block";
          }
          return 0;
        }
      } catch (e) {
        console.error(e);
        if (!silent) {
          alert("Ошибка при проверке баланса: " + e.message);
        }
        return 0;
      }
    }

    // Сохранение найденного кошелька
    function saveFoundWallet(walletInfo) {
      // Показываем блок с найденными кошельками
      foundWalletsEl.style.display = "block";
      
      // Добавляем кошелёк в список
      const walletItem = document.createElement("div");
      walletItem.className = "wallet-item";
      walletItem.innerHTML = `
        <p><strong>Мнемоника:</strong> ${walletInfo.mnemonic}</p>
        <p><strong>Адрес:</strong> ${walletInfo.address}</p>
        <p><strong>Баланс:</strong> ${walletInfo.balance} TON</p>
      `;
      foundWalletsEl.appendChild(walletItem);
      
      // Также сохраняем в localStorage
      const savedWallets = JSON.parse(localStorage.getItem('tonFoundWallets') || '[]');
      savedWallets.push(walletInfo);
      localStorage.setItem('tonFoundWallets', JSON.stringify(savedWallets));
      
      // Предлагаем пользователю скачать файл с кошельками
      downloadWalletsFile();
    }

    // Скачивание файла с кошельками
    function downloadWalletsFile() {
      const data = JSON.stringify(foundWallets, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      // Создаем скрытую ссылку для скачивания
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ton_wallets_with_balance.json';
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      
      // Очищаем
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    }

    // Загрузка ранее найденных кошельков при запуске
    function loadSavedWallets() {
      const savedWallets = JSON.parse(localStorage.getItem('tonFoundWallets') || '[]');
      if (savedWallets.length > 0) {
        foundWallets = savedWallets;
        foundCount = savedWallets.length;
        foundCountEl.textContent = foundCount;
        
        // Показываем найденные кошельки
        foundWalletsEl.style.display = "block";
        foundWalletsEl.innerHTML = "<h3>Найденные кошельки с балансом:</h3>";
        
        savedWallets.forEach(walletInfo => {
          const walletItem = document.createElement("div");
          walletItem.className = "wallet-item";
          walletItem.innerHTML = `
            <p><strong>Мнемоника:</strong> ${walletInfo.mnemonic}</p>
            <p><strong>Адрес:</strong> ${walletInfo.address}</p>
            <p><strong>Баланс:</strong> ${walletInfo.balance} TON</p>
          `;
          foundWalletsEl.appendChild(walletItem);
        });
      }
    }

    // Загружаем сохраненные кошельки при запуске
    loadSavedWallets();
  </script>
</body>
</html>