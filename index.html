<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>TON Автоматическая проверка кошельков</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px;
    }
    h1 { color: #2c3e50; }
    .auto-mode {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 600px;
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #2980b9; }
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    .stats {
      margin-top: 10px;
      font-size: 14px;
      color: #7f8c8d;
    }
    .found-wallets {
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 5px;
    }
    .wallet-item {
      margin-bottom: 10px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 5px;
      border-left: 4px solid #2ecc71;
    }
    .current-phrase {
      margin: 15px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px dashed #ccc;
    }
    .current-phrase-text {
      font-family: monospace;
      word-break: break-all;
      color: #e74c3c;
    }
    .wallet-info {
      margin: 15px 0;
      padding: 10px;
      background: #e8f4fc;
      border-radius: 8px;
      border: 1px solid #3498db;
    }
    .wallet-info p {
      margin: 5px 0;
    }
    .wallet-address {
      font-weight: bold;
      color: #16a085;
      word-break: break-all;
      font-family: monospace;
    }
    .wallet-balance {
      font-weight: bold;
      color: #8e44ad;
    }
  </style>
</head>
<body>
  <h1>TON Автоматическая проверка кошельков</h1>
  
  <div class="auto-mode">
    <h2>Автоматический режим</h2>
    <button id="startAutoBtn">Запустить автоматическую генерацию</button>
    <button id="stopAutoBtn" disabled>Остановить</button>
    
    <div class="current-phrase">
      <p><strong>Текущая проверяемая фраза:</strong></p>
      <div id="currentPhrase" class="current-phrase-text">Не активен</div>
    </div>
    
    <div class="wallet-info">
      <p><strong>Адрес кошелька:</strong></p>
      <div id="walletAddress" class="wallet-address">-</div>
      <p><strong>Баланс:</strong> <span id="walletBalance">-</span> TON</p>
    </div>
    
    <div class="stats">
      <p>Сгенерировано кошельков: <span id="generatedCount">0</span></p>
      <p>Найдено с балансом: <span id="foundCount">0</span></p>
      <p>Статус: <span id="status">Остановлено</span></p>
    </div>
    
    <div id="foundWallets" class="found-wallets" style="display: none;">
      <h3>Найденные кошельки с балансом:</h3>
    </div>
  </div>

  <script type="module">
    import { mnemonicToWalletKey, mnemonicNew } from "https://esm.sh/@ton/crypto";
    import { WalletContractV4 } from "https://esm.sh/@ton/ton";

    const startAutoBtn = document.getElementById("startAutoBtn");
    const stopAutoBtn = document.getElementById("stopAutoBtn");
    const generatedCountEl = document.getElementById("generatedCount");
    const foundCountEl = document.getElementById("foundCount");
    const statusEl = document.getElementById("status");
    const foundWalletsEl = document.getElementById("foundWallets");
    const currentPhraseEl = document.getElementById("currentPhrase");
    const walletAddressEl = document.getElementById("walletAddress");
    const walletBalanceEl = document.getElementById("walletBalance");

    let isAutoModeRunning = false;
    let generatedCount = 0;
    let foundCount = 0;
    let foundWallets = [];
    let currentAddress = "";

    // Запуск автоматического режима
    startAutoBtn.addEventListener("click", () => {
      isAutoModeRunning = true;
      startAutoBtn.disabled = true;
      stopAutoBtn.disabled = false;
      statusEl.textContent = "Выполняется...";
      runAutoMode();
    });

    // Остановка автоматического режима
    stopAutoBtn.addEventListener("click", () => {
      isAutoModeRunning = false;
      startAutoBtn.disabled = false;
      stopAutoBtn.disabled = true;
      statusEl.textContent = "Остановлено";
      currentPhraseEl.textContent = "Не активен";
      walletAddressEl.textContent = "-";
      walletBalanceEl.textContent = "-";
    });

    // Функция автоматической генерации и проверки
    async function runAutoMode() {
      while (isAutoModeRunning) {
        try {
          await generateAndCheck();
          // Небольшая задержка между запросами чтобы не перегружать API
          await new Promise(resolve => setTimeout(resolve, 1000));
        } catch (e) {
          console.error("Ошибка в автоматическом режиме:", e);
          // Продолжаем работу даже при ошибках
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
      }
    }

    // Генерация и проверка кошелька
    async function generateAndCheck() {
      const phrase = await generateWallet();
      if (phrase && currentAddress) {
        await checkBalance(phrase, currentAddress);
      }
    }

    // Функция генерации кошелька
    async function generateWallet() {
      // Генерируем новую мнемоническую фразу (24 слова)
      const mnemonic = await mnemonicNew(24);
      const mnemonicPhrase = mnemonic.join(" ");
      
      // Отображаем текущую фразу в автоматическом режиме
      currentPhraseEl.textContent = mnemonicPhrase;
      
      // Получаем ключи из мнемоники
      const keyPair = await mnemonicToWalletKey(mnemonic);

      // Создаём кошелёк версии 4
      const wallet = WalletContractV4.create({
        workchain: 0,
        publicKey: keyPair.publicKey,
      });
      
      currentAddress = wallet.address.toString();
      
      // Обновляем счетчик
      generatedCount++;
      generatedCountEl.textContent = generatedCount;
      
      // Обновляем адрес кошелька
      walletAddressEl.textContent = currentAddress;
      
      return mnemonicPhrase;
    }

    // Функция проверки баланса
    async function checkBalance(phrase, address) {
      try {
        // Получаем баланс через toncenter API
        const url = `https://toncenter.com/api/v2/getAddressInformation?address=${address}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.ok) {
          const balance = parseInt(data.result.balance, 10) / 1e9;
          
          // Обновляем отображение баланса
          walletBalanceEl.textContent = balance.toFixed(6);
          
          // Если баланс больше 0, сохраняем информацию
          if (balance > 0) {
            foundCount++;
            foundCountEl.textContent = foundCount;
            
            const walletInfo = {
              mnemonic: phrase,
              address: address,
              balance: balance
            };
            
            foundWallets.push(walletInfo);
            saveFoundWallet(walletInfo);
            
            // Показываем уведомление
            alert(`Найден кошелёк с балансом! ${balance} TON`);
          }
          
          return balance;
        } else {
          walletBalanceEl.textContent = "0 (ошибка API)";
          return 0;
        }
      } catch (e) {
        console.error(e);
        walletBalanceEl.textContent = "0 (ошибка)";
        return 0;
      }
    }

    // Сохранение найденного кошелька
    function saveFoundWallet(walletInfo) {
      // Показываем блок с найденными кошельками
      foundWalletsEl.style.display = "block";
      
      // Добавляем кошелёк в список
      const walletItem = document.createElement("div");
      walletItem.className = "wallet-item";
      walletItem.innerHTML = `
        <p><strong>Мнемоника:</strong> ${walletInfo.mnemonic}</p>
        <p><strong>Адрес:</strong> ${walletInfo.address}</p>
        <p><strong>Баланс:</strong> ${walletInfo.balance} TON</p>
      `;
      foundWalletsEl.appendChild(walletItem);
      
      // Также сохраняем в localStorage
      const savedWallets = JSON.parse(localStorage.getItem('tonFoundWallets') || '[]');
      savedWallets.push(walletInfo);
      localStorage.setItem('tonFoundWallets', JSON.stringify(savedWallets));
      
      // Предлагаем пользователю скачать файл с кошельками
      downloadWalletsFile();
    }

    // Скачивание файла с кошельками
    function downloadWalletsFile() {
      const data = JSON.stringify(foundWallets, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      // Создаем скрытую ссылку для скачивания
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ton_wallets_with_balance.json';
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      
      // Очищаем
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    }

    // Загрузка ранее найденных кошельков при запуске
    function loadSavedWallets() {
      const savedWallets = JSON.parse(localStorage.getItem('tonFoundWallets') || '[]');
      if (savedWallets.length > 0) {
        foundWallets = savedWallets;
        foundCount = savedWallets.length;
        foundCountEl.textContent = foundCount;
        
        // Показываем найденные кошельки
        foundWalletsEl.style.display = "block";
        foundWalletsEl.innerHTML = "<h3>Найденные кошельки с балансом:</h3>";
        
        savedWallets.forEach(walletInfo => {
          const walletItem = document.createElement("div");
          walletItem.className = "wallet-item";
          walletItem.innerHTML = `
            <p><strong>Мнемоника:</strong> ${walletInfo.mnemonic}</p>
            <p><strong>Адрес:</strong> ${walletInfo.address}</p>
            <p><strong>Баланс:</strong> ${walletInfo.balance} TON</p>
          `;
          foundWalletsEl.appendChild(walletItem);
        });
      }
    }

    // Загружаем сохраненные кошельки при запуске
    loadSavedWallets();
  </script>
</body>
</html>
